<div class="flex justify-between">
    <h1 class="primaryTxt font-bold text-2xl leading-9">
          {{'Item'| translate }} {{'Card'| translate }} {{ showAverageColumn ? ' With Average Information' : '' }}
    </h1>
</div>

<div class="my-5 flex flex-wrap md:flex-nowrap items-end space-x-0 md:space-x-6 space-y-4 md:space-y-0 mb-6">
    <!-- Store Selector -->

    <div class="w-full md:w-1/4">
        <label class="block mb-2 text-sm font-medium text-gray-900" for="store">{{'Store'| translate }}</label>
        <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 w-full" id="store"
            [(ngModel)]="selectedStoreId" (ngModelChange)="onFilterChange()" required>
            <option [ngValue]="null" disabled selected hidden> {{'Choose'| translate }} {{'Store'| translate }}</option>
            <option *ngFor="let store of stores" [ngValue]="store.id">{{ store.name }}</option>
        </select>
    </div>

    <!-- Item Selector -->
    <div class="w-full md:w-1/4">
        <label class="block mb-2 text-sm font-medium text-gray-900" for="item">{{'Item'| translate }}</label>
        <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 w-full" id="item"
            [(ngModel)]="selectedItemId" (ngModelChange)="onFilterChange()" required>
            <option [ngValue]="null" disabled selected hidden>{{'Choose'| translate }} {{'Item'| translate }}</option>
            <option *ngFor="let item of items" [ngValue]="item.id">{{ item.enName }}</option>
        </select>
    </div>


    <!-- Date From -->
    <div class="w-full md:w-1/4">
        <label class="block mb-2 text-sm font-medium text-gray-900" for="dateFrom">{{'Date From'| translate }}</label>
        <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 w-full"
            id="dateFrom" [(ngModel)]="dateFrom" (ngModelChange)="onFilterChange()" required>
    </div>

    <!-- Date To -->
    <div class="w-full md:w-1/4">
        <label class="block mb-2 text-sm font-medium text-gray-900" for="dateTo">{{'Date To'| translate }}</label>
        <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 w-full"
            id="dateTo" [(ngModel)]="dateTo" (ngModelChange)="onFilterChange()" required>
    </div>

    <div class="w-full md:w-1/6 flex justify-end mt-4 md:mt-0">
        <button class="p-3 font-medium text-xl rounded-lg" (click)="viewReport()"
            [disabled]="!dateFrom || !dateTo || !selectedStoreId || !selectedItemId" [ngClass]="{
                'bg-gray-100 text-gray-300': !dateFrom || !dateTo || !selectedStoreId || !selectedItemId,
                'secondaryBg text-white': dateFrom && dateTo && selectedStoreId && selectedItemId
            }">
            {{'View Report'| translate }}

        </button>
    </div>
</div>


<div *ngIf="showTable" class="mb-5 flex justify-end space-x-4 rtl:space-x-reverse">
    <img class="w-5 cursor-pointer" src="Icons/Excel.png" (click)="exportExcel()" Export to Excel>
    <img class="w-5 cursor-pointer" src="Icons/PDF.png" (click)="DownloadAsPDF()" title="Export to PDF">
    <img class="w-5 cursor-pointer" src="Icons/Print.png" (click)="Print()" title="Print Report">
</div>


<div *ngIf="showTable" class="mt-5 overflow-x-auto rounded-2xl border border-[#BDBDBD]">
    <table class="w-full tabe inset-0 bg-[#EBEBEB] text-left rtl:text-right text-[#6F6F6F]">
        <thead class="bg-[#EBEBEB] text-sm md:text-base border border-[#BDBDBD] border-t-0 border-l-0">
            <tr>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                     {{'Date'| translate }}
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                  {{'Transaction Type'| translate }}
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                     {{'Invoice Number'| translate }}
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                     {{'Authority'| translate }}
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                     {{'Income'| translate }}
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                     {{'Outcome'| translate }}
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                     {{'Balance'| translate }}
                </th>
                <!-- <th *ngIf="showAverageColumn"
                    class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                    Cost Balance
                </th> -->
                <th *ngIf="showAverageColumn"
                    class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                     {{'Price'| translate }}
                </th>
                <th *ngIf="showAverageColumn"
                    class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                      {{'Total'| translate }} {{'Price'| translate }}
                </th>
                <th *ngIf="showAverageColumn"
                    class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                      {{'Average'| translate }} {{'Cost'| translate }}
                </th>
            </tr>
        </thead>
        <tbody>
            <tr *ngIf="combinedData.length === 0">
                <td [attr.colspan]="showAverageColumn ? 11 : 7"
                    class="bg-white px-4 py-2 h-[72px] text-center border-t border-gray-300 text-xs md:text-sm">
                     {{'No Data Found'| translate }}
                </td>
            </tr>

            <tr *ngFor="let row of combinedData; let i = index" [ngClass]="{ 
                    'bg-[#F7F7F7]': i % 2 === 1, 
                    'bg-white': i % 2 !== 1,
                    'font-bold': row.isSummary
                }" class="border-t border-gray-300 text-xs md:text-sm">
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.date ? (row.date | date:'yyyy-MM-dd') : '-' }}
                </td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.transactionType }}
                </td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.invoiceNumber }}
                </td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.authority }}
                </td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.income }}
                </td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.outcome }}
                </td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.balance }}
                </td>
                <!-- <td *ngIf="showAverageColumn" class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.isSummary ? (row.costBalance !== '-' ? (row.costBalance | number:'1.2-2') : '-') : '-' }}  
                </td> -->
                <td *ngIf="showAverageColumn" class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.price }}
                </td>
                <td *ngIf="showAverageColumn" class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.totalPrice }}
                </td>
                <td *ngIf="showAverageColumn" class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    {{ row.averageCost }}
                </td>
            </tr>
        </tbody>
    </table>
</div>


<div id="Data" class="hidden">
    <app-pdf-print *ngIf="showPDF" [school]="school" [fileName]="'Item Card Report'" 
        [tableHeaders]="showAverageColumn 
            ? ['Date', 'Type', '#', 'Authority', 'Income', 'Outcome', 'Balance', 'Price', 'Total Price', 'Avg']
            : ['Date', 'Type', '#', 'Authority', 'Income', 'Outcome', 'Balance']"
        [infoRows]="[
            { keyEn: 'From Date: ' + dateFrom },
            { keyEn: 'To Date: ' + dateTo },
            { keyEn: 'Store: ' + getStoreName() },
            { keyEn: 'Item: ' + getItemName() },
        ]"
        [tableData]="transactionsForExport" #pdfPrintComponent>
    </app-pdf-print>
</div>

<!--         [tableHeaders]="['Invoice #', 'Date', 'Store', 'Total Amount', 'Transaction Type']"
 -->

<!-- <div class="absolute  -top-[9999px] -left-[9999px]">
    <div id="Data" class="hidden">
        <app-pdf-print *ngIf="showPDF" [school]="school" [fileName]="'Inventory Transactions Report'"
        [infoRows]="[
      { keyEn: 'From Date: ' + this.dateFrom },
      { keyEn: 'To Date: ' + this.dateTo },
      { keyEn: 'Store: ' + this.getStoreName() },
            ]"
        [tableHeaders]="['Invoice #', 'Date', 'Store', 'Total Amount', 'Transaction Type']"
        [tableData]="transactionsForExport" #pdfComponentRef>
    </app-pdf-print>
</div>
</div> -->



<!-- Pagination Controls -->
<div *ngIf="showTable && totalPages > 0" class="mt-8 flex justify-between items-center">
    <div class="flex items-center space-x-4 rtl:space-x-reverse">
        <button class="flex items-center space-x-2 rounded-lg border py-3 px-4 rtl:space-x-reverse"
            (click)="changeCurrentPage(currentPage-1)" 
            [disabled]="currentPage == 1 || combinedData.length == 0"
            [ngClass]="{'cursor-not-allowed opacity-50': currentPage == 1 || combinedData.length == 0}">
            <i class="fa-solid fa-arrow-left"></i>
            <p>{{'Previous'| translate }}</p>
        </button>

        <div class="flex">
            <div *ngFor="let page of visiblePages" class="rounded-lg py-[10px] w-[40px]"
                [ngClass]="{'border': page === currentPage, 'hover:bg-gray-100': page == currentPage, 'hover:bg-gray-100 cursor-pointer': page !== currentPage }"
                (click)="changeCurrentPage(page)">
                <p class="text-center">{{ page }}</p>
            </div>
        </div>
        
        <button class="flex items-center space-x-2 rounded-lg border py-3 px-4 rtl:space-x-reverse"
            (click)="changeCurrentPage(currentPage+1)" 
            [disabled]="currentPage == totalPages || combinedData.length == 0"
            [ngClass]="{'cursor-not-allowed opacity-50': currentPage == totalPages || combinedData.length == 0}">
            <p>{{'Next'| translate }}</p>
            <i class="fa-solid fa-arrow-right"></i>
        </button>
    </div>

    <div class="flex items-center space-x-2 rtl:space-x-reverse">
        <input 
            class="rounded-lg border py-3 px-4 w-[73px]" 
            [(ngModel)]="pageSize" 
            min="1"
            (ngModelChange)="onPageSizeChange($event)">
        <p>{{'items Per Page'| translate }}</p>
    </div>  

    <div>
        <p>{{currentPage}} {{'of'| translate }} {{totalPages}} {{'pages'| translate }} ({{totalRecords}} {{'Item'| translate }})</p>
    </div>
</div>
<!-- end Pagination-->
<!-- all-store-balance.component.html -->
<div class="flex justify-between mb-3">
    <h1 class="primaryTxt font-semibold text-2xl leading-9">{{ pageTitle|translate }}</h1>
</div>

<!-- Filter Controls -->
<div class="flex flex-wrap md:flex-nowrap items-end space-x-0 md:space-x-6 rtl:space-x-reverse space-y-4 md:space-y-0 mb-6">
    <!-- Date To -->
    <div class="w-full md:w-1/4">
        <label for="dateTo" class="block mb-2 text-sm font-medium text-gray-900"> {{ 'Date To' | translate }}</label>
        <input id="dateTo" type="date" [(ngModel)]="dateTo" (ngModelChange)="onFilterChange()" required
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 w-full">
    </div>

    <!-- Category Selector -->
    <div class="w-full md:w-1/4">
        <label for="category" class="block mb-2 text-sm font-medium text-gray-900">{{ 'Category' | translate }}</label>
        <select id="category" [(ngModel)]="selectedCategoryId" (ngModelChange)="onFilterChange()"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 w-full">
            <option [ngValue]="null"> {{ 'All' | translate }} {{ 'Categories' | translate }}</option>
            <option *ngFor="let category of categories" [ngValue]="category.id">{{ category.name }}</option>
            <option value="null" *ngIf="categories.length == 0" disabled>{{'No Categories Available'| translate }}</option>

        </select>
    </div>

    <!-- Checkboxes -->
    <div class="w-full md:w-1/3 flex flex-col">
        <label class="block mb-2 text-sm font-medium text-gray-900"> {{ 'Filters' | translate }}</label>
        <div class="flex flex-wrap gap-4">
            <div class="flex items-center  space-x-2 rtl:space-x-reverse">
                <input type="checkbox" id="hasBalance" [(ngModel)]="hasBalance" (ngModelChange)="onFilterChange()" class="mr-2 accent-secondaryBg">
                <label for="hasBalance" class="text-sm text-gray-700"> {{ 'Has Balance' | translate }}</label>
            </div>
            <div class="flex items-center  space-x-2 rtl:space-x-reverse">
                <input type="checkbox" id="overdrawnBalance" [(ngModel)]="overdrawnBalance" (ngModelChange)="onFilterChange()" class="mr-2 accent-secondaryBg">
                <label for="overdrawnBalance" class="text-sm text-gray-700"> {{ 'Overdrawn Balance' | translate }}</label>
            </div>
            <div class="flex items-center  space-x-2 rtl:space-x-reverse">
                <input type="checkbox" id="zeroBalances" [(ngModel)]="zeroBalances" (ngModelChange)="onFilterChange()" class="mr-2 accent-secondaryBg">
                <label for="zeroBalances" class="text-sm text-gray-700">{{ 'Zero Balances' | translate }}</label>
            </div>
        </div>
    </div>

    <div class="w-full md:w-1/6 flex justify-end mt-4 md:mt-0">
        <button class="p-3 font-medium text-xl rounded-lg" (click)="viewReport()" [disabled]="!dateTo" [ngClass]="{
                'bg-gray-100 text-gray-300': !dateTo,
                'secondaryBg text-white': dateTo
            }">
             {{ 'View Report' | translate }}
        </button>
    </div>
</div>

<div *ngIf="showTable" class="mb-5 flex justify-end space-x-4 rtl:space-x-reverse">
    <img class="w-5 cursor-pointer" src="https://d393tpgdl2mqkp.cloudfront.net/public/Icons/Excel.png" (click)="exportExcel()" title="Export to Excel">
    <img class="w-5 cursor-pointer" src="https://d393tpgdl2mqkp.cloudfront.net/public/Icons/PDF.png" (click)="DownloadAsPDF()" title="Export to PDF">
    <img class="w-5 cursor-pointer" src="https://d393tpgdl2mqkp.cloudfront.net/public/Icons/Print.png" (click)="Print()" title="Print Report">
</div>

<div *ngIf="showTable" class="mt-5 overflow-x-auto">
    <div class="flex space-x-4 rtl:space-x-reverse pb-2">
        <!-- Fixed Columns Table (Item Code, Item Name) -->
        <div class="flex-shrink-0">
            <!-- Store Name Header - Styled as section title -->
            <div class="primaryTxt font-semibold text-2xl leading-9 mb-3">
                {{ 'Items' | translate }}
            </div>

            <div class="overflow-x-auto rounded-2xl border border-[#BDBDBD]">
                <table class="w-full table inset-0 bg-[#EBEBEB] text-left rtl:text-right text-[#6F6F6F]">
                    <thead class="bg-[#EBEBEB] text-sm md:text-base border border-[#BDBDBD] border-t-0 border-l-0">
                        <tr>
                            <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                                {{ 'Item Code' | translate }}
                            </th>
                            <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                                {{ 'Item Name' | translate }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="!reportData?.data?.length">
                            <td colspan="2" class="bg-white px-4 py-2 h-[72px] text-center border-t border-gray-300 text-xs md:text-sm">
                                {{ 'No Data Found' | translate }}
                            </td>
                        </tr>
                        <tr *ngFor="let item of reportData?.data; let i = index" 
                            [ngClass]="{ 
                                'bg-[#F7F7F7]': i % 2 === 1, 
                                'bg-white': i % 2 !== 1
                            }" 
                            class="border-t border-gray-300 text-xs md:text-sm">
                            <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                                {{ item.itemCode }}
                            </td>
                            <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                                {{ item.itemName }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Store Tables -->
        <div *ngFor="let store of getStoreColumns()" class="flex-shrink-0">
            <!-- Store Name Header - Styled as section title -->
            <div class="primaryTxt font-semibold text-2xl leading-9 mb-3">
                {{ store }}
            </div>
            
            <div class="overflow-x-auto rounded-2xl border border-[#BDBDBD]">
                <!-- Store Data Table -->
                <table class="w-full table inset-0 bg-[#EBEBEB] text-left rtl:text-right text-[#6F6F6F]">
                    <thead class="bg-[#EBEBEB] text-sm md:text-base border border-[#BDBDBD] border-t-0 border-l-0">
                        <tr>
                            <th class="py-3 px-4 min-w-[80px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                                {{ 'Quantity' | translate }}
                            </th>
                            <th *ngIf="showPriceColumn()" 
                                class="py-3 px-4 min-w-[100px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                                {{ getPriceColumnLabel() | translate }}
                            </th>
                            <th *ngIf="showPriceColumn()" 
                                class="py-3 px-4 min-w-[100px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                                {{ 'Value' | translate }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="!reportData?.data?.length">
                            <td [attr.colspan]="showPriceColumn() ? 3 : 1" class="bg-white px-4 py-2 h-[72px] text-center border-t border-gray-300 text-xs md:text-sm">
                                {{ 'No Data Found' | translate }}
                            </td>
                        </tr>
                        <tr *ngFor="let item of reportData?.data; let i = index" 
                            [ngClass]="{ 
                                'bg-[#F7F7F7]': i % 2 === 1, 
                                'bg-white': i % 2 !== 1
                            }" 
                            class="border-t border-gray-300 text-xs md:text-sm">
                            <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                                {{ getStoreData(item, store).quantity ?? '0' | number:(getStoreData(item, store).hasDecimalQuantity ? '1.2-2' : '1.0-0') }}
                            </td>
                            <td *ngIf="showPriceColumn()" class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                                <ng-container *ngIf="getStoreData(item, store).hasDecimalPrice; else noDecimal">
                                    {{ getStoreData(item, store).price | number:'1.2-2' }}
                                </ng-container>
                                <ng-template #noDecimal>
                                    {{ getStoreData(item, store).price | number:'1.0-0' }}
                                </ng-template>
                            </td>
                            <td *ngIf="showPriceColumn()" class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                                {{ (getStoreData(item, store).value | number:(getStoreData(item, store).hasDecimalValue ? '1.2-2' : '1.0-0') ) ?? '0' }}
                            </td>
                        </tr>
                        <!-- Store Total Row -->
                        <tr *ngIf="reportData?.data?.length" class="bg-[#E5E5E5] font-semibold border-t border-gray-400">
                            <td class="py-3 px-4 border border-[#EAECF0] border-l-0 font-bold">
                                {{ getStoreTotalQuantity(store).value | number:(getStoreTotalQuantity(store).hasDecimal ? '1.2-2' : '1.0-0') }}
                            </td>
                            <td *ngIf="showPriceColumn()" class="py-3 px-4 border border-[#EAECF0] border-l-0 font-bold">
                                -
                            </td>
                            <td *ngIf="showPriceColumn()" class="py-3 px-4 border border-[#EAECF0] border-l-0 font-bold">
                                {{ getStoreTotalValue(store).value | number:(getStoreTotalValue(store).hasDecimal ? '1.2-2' : '1.0-0') }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Grand Total Table -->
        <div class="flex-shrink-0">
            <!-- Grand Total Header - Styled as section title -->
            <div class="primaryTxt font-semibold text-2xl leading-9 mb-3">
                {{ 'Grand Total' | translate }}
            </div>
            
            <div class="overflow-x-auto rounded-2xl border border-[#BDBDBD]">
                <table class="w-full table inset-0 bg-[#EBEBEB] text-left rtl:text-right text-[#6F6F6F]">
                    <thead class="bg-[#EBEBEB] text-sm md:text-base border border-[#BDBDBD] border-t-0 border-l-0">
                        <tr>
                            <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                                {{ 'Total' | translate }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="!reportData?.data?.length">
                            <td class="bg-white px-4 py-2 h-[72px] text-center border-t border-gray-300 text-xs md:text-sm">
                                {{ 'No Data Found' | translate }}
                            </td>
                        </tr>
                        <tr *ngFor="let item of reportData?.data; let i = index" 
                            [ngClass]="{ 
                                'bg-[#F7F7F7]': i % 2 === 1, 
                                'bg-white': i % 2 !== 1
                            }" 
                            class="border-t border-gray-300 text-xs md:text-sm">
                            <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                                {{ '-'}}
                            </td>
                        </tr>
                        <!-- Grand Total Summary Row -->
                        <tr *ngIf="reportData?.data?.length && reportData?.grandTotals" class="bg-[#E5E5E5] font-semibold border-t border-gray-400">
                            <td class="py-3 px-4 border border-[#EAECF0] border-l-0 font-bold">
                                <ng-container *ngIf="reportType === 'QuantityOnly'">
                                    {{ reportData?.grandTotals?.TotalQuantity ?? 0 | number:(hasDecimal(reportData?.grandTotals?.TotalQuantity ?? 0) ? '1.2-2' : '1.0-0') }}
                                </ng-container>
                                <ng-container *ngIf="reportType !== 'QuantityOnly'">
                                    {{ reportData?.grandTotals?.TotalValue ?? 0 | number:(hasDecimal(reportData?.grandTotals?.TotalValue ?? 0) ? '1.2-2' : '1.0-0') }}
                                </ng-container>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="absolute -top-[9999px] -left-[9999px]">
    <div id="Data" class="hidden">
        <app-pdf-print *ngIf="showPDF" [school]="school" [fileName]="pageTitle" 
        [infoRows]="[   
      { keyEn: 'Report Type: ' + this.pageTitle , keyAr: this.pageTitle + ' : نوع التقرير' },
      { keyEn: 'To Date: ' + this.dateTo , keyAr: this.dateTo + ' : إلى تاريخ' },
      { keyEn: 'Category: ' + this.getCategoryName() , keyAr: this.getCategoryName() + ' : الفئة' },
      { keyEn: 'Filters: ' + this.getBalanceFiltersInfo() , keyAr: this.getBalanceFiltersInfo() + 'رصيد: '},]"
            [tableDataWithHeaderArray]="cachedTableDataForPDF" #pdfPrintComponent>
        </app-pdf-print>
    </div>
</div>


<!-- Pagination Controls Gaber --77 -->
<div *ngIf="showTable && totalPages > 0" class="mt-8 flex justify-between items-center">
    <div class="flex items-center space-x-4 rtl:space-x-reverse">
        <button class="flex items-center space-x-2 rounded-lg border py-3 px-4 rtl:space-x-reverse"
            (click)="changeCurrentPage(currentPage-1)" 
            [disabled]="currentPage == 1 || !reportData?.data?.length"
            [ngClass]="{'cursor-not-allowed opacity-50': currentPage == 1 || !reportData?.data?.length}">
            <i class="fa-solid fa-arrow-left"></i>
            <p>{{'Previous'| translate }}</p>
        </button>

        <div class="flex">
            <div *ngFor="let page of visiblePages" class="rounded-lg py-[10px] w-[40px]"
                [ngClass]="{'border': page === currentPage, 'hover:bg-gray-100': page == currentPage, 'hover:bg-gray-100 cursor-pointer': page !== currentPage }"
                (click)="changeCurrentPage(page)">
                <p class="text-center">{{ page }}</p>
            </div>
        </div>
        
        <button class="flex items-center space-x-2 rounded-lg border py-3 px-4 rtl:space-x-reverse"
            (click)="changeCurrentPage(currentPage+1)" 
            [disabled]="currentPage == totalPages || !reportData?.data?.length"
            [ngClass]="{'cursor-not-allowed opacity-50': currentPage == totalPages || !reportData?.data?.length}">
            <p>{{'Next'| translate }}</p>
            <i class="fa-solid fa-arrow-right"></i>
        </button>
    </div>

    <div class="flex items-center space-x-2 rtl:space-x-reverse">
        <input 
            class="rounded-lg border py-3 px-4 w-[73px]" 
            [(ngModel)]="pageSize" 
            min="1"
            (ngModelChange)="onPageSizeChange($event)">
        <p>{{'items Per Page'| translate }}</p>
    </div>  

    <div>
        <p>{{currentPage}} {{'of'| translate }} {{totalPages}} {{'pages'| translate }} ({{totalRecords}} {{'Item'| translate }})</p>
    </div>
</div>
<!-- end Pagination  --77 -->


<div class="flex justify-between">
    <h1 class="font-semibold text-2xl leading-9">Time Table</h1>
    <div class="flex justify-between items-center">
        <app-search [keysArray]="keysArray" (searchEvent)="onSearchEvent($event)"></app-search>
        <button (click)="openModal()"
            class="rounded-lg secondaryBorder secondaryTxt px-4 py-3 flex items-center justify-center gap-2">
            Create Time Table
        </button>
    </div>
</div>

<div class="flex justify-start items-center space-x-4">
    <div class="w-full">
        <label for="School1" class="block mb-2 text-sm font-medium text-gray-900">School</label>
        <select id="School1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 w-full"
            [(ngModel)]="SelectedSchoolId" (change)="GetAllData();"
            (ngModelChange)="onInputValueChange({ field: 'schoolID', value: $event })">
            <option value=0 disabled selected hidden>Select a School</option>
            <option *ngFor="let stu of schools" [value]="stu.id">
                {{ stu.name }}
            </option>
            <option *ngIf="schools.length === 0" disabled selected>No Data Found</option>
        </select>
        <span *ngIf="validationErrors['schoolID']" class="text-red-500 ml-3 font-normal">{{ validationErrors['schoolID']
            }}</span>
    </div>
</div>

<div *ngIf="SelectedSchoolId!=0" class="mt-5 overflow-x-auto rounded-2xl border border-[#BDBDBD] max-w-full">
    <table class="overflow-auto w-full bg-[#EBEBEB] text-left text-[#6F6F6F]">
        <thead class="bg-[##EBEBEB] text-sm md:text-base border border-[#BDBDBD] border-t-0 border-l-0">
            <tr>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                    Id
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap  border border-[#EAECF0] border-t-0 border-l-0">
                    Name
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap  border border-[#EAECF0] border-t-0 border-l-0">
                    Create Date
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap  border border-[#EAECF0] border-t-0 border-l-0">
                    Favorite
                </th>
                <th class="py-3 px-4 min-w-[120px] whitespace-nowrap border border-[#EAECF0] border-t-0 border-l-0">
                    Actions
                </th>
            </tr>
        </thead>
        <tbody>
            <tr *ngIf="TableData.length === 0">
                <td colspan="7"
                    class="bg-white px-4 py-2 h-[72px] text-center border-t border-gray-300 text-xs md:text-sm">
                    No Data Found
                </td>
            </tr>

            <tr *ngFor="let row of TableData; let i = index"
                [ngClass]="{'bg-[#F7F7F7]': i % 2 === 1, 'bg-white': i % 2 !== 1}"
                class="border-t border-gray-300 text-xs md:text-sm">

                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0 text-[#2E3646]">{{ row.id }}</td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">{{ row.name }}</td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">{{ row.insertedAt | date:
                    'dd/MM/yyyy HH:mm' }}</td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0">
                    <div class="flex w-full space-x-5 items-center mb-4">
                        <input type="checkbox" id="hide" class="w-5 h-5" [(ngModel)]="row.isFavourite"
                            (change)="EditFavourite(row.id,row.isFavourite);">
                    </div>
                </td>
                <td class="py-5 px-4 border border-[#EAECF0] border-t-0 border-l-0 ">
                    <div class="flex space-x-3">
                        <button *ngIf="AllowDelete && IsAllowDelete(row.insertedByUserId)" (click)="delete(row.id)">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                        <button *ngIf="AllowEdit && IsAllowEdit(row.insertedByUserId)" (click)="View(row.id)">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button  (click)="openPrintModal(row.id)">
                            <img class="w-4 cursor-pointer" src="Icons/Print.png" title="Print">
                        </button>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>


<!-- Add-Edit School Type Modal -->
<div id="Add_Modal" class="fixed inset-0 z-50 justify-center items-center w-full h-full bg-black/50 hidden">
    <div class="bg-white rounded-2xl p-12 w-[669px]">
        <div class="flex justify-between items-center">
            <h1 class="font-semibold text-2xl leading-9">Create TimeTable</h1>
            <button (click)="closeModal()" type="button"
                class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg">X</button>
        </div>

        <div class="p-[16px_24px] mt-6 mb-4 bg-[#F7F7F7] rounded-3xl">
            <div class="flex flex-col mb-4">
                <label class="mb-2 primaryTxt" for="name">TimeTable</label>
                <input id="name" type="text" class="rounded-lg border border-solid border-gray-300 px-4 py-3"
                    placeholder="Enter TimeTable" [(ngModel)]="timetable.name"
                    (ngModelChange)="onInputValueChange({ field: 'name', value: $event })" />
                <span *ngIf="validationErrors['name']" class="text-red-500 ml-3 font-normal">{{ validationErrors['name']
                    }}</span>
            </div>
        </div>

        <div class="flex justify-end">
            <button [disabled]="isLoading" class="secondaryBg text-white font-medium px-4 py-2 rounded-lg"
                (click)="Generate()">
                <span *ngIf="!isLoading">Generate</span>
                <i *ngIf="isLoading" class="fas fa-spinner fa-spin"></i>
            </button>
        </div>
    </div>
</div>


<!-- Add-Edit School Type Modal -->
<div id="Print_Modal" class="fixed inset-0 z-50 justify-center items-center w-full h-full bg-black/50 hidden">
    <div class="bg-white rounded-2xl p-12 w-[669px]">
        <div class="flex justify-between items-center">
            <h1 class="font-semibold text-2xl leading-9">Print Time Table</h1>
            <button (click)="closePrintModal()" type="button"
                class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg">X</button>
        </div>

        <div class="p-[16px_24px] mt-6 mb-4 bg-[#F7F7F7] rounded-3xl">
            <div class="flex flex-col mb-4">
                <label class="mb-2 primaryTxt" for="Type">Type</label>
                <select class="rounded-lg border border-solid border-gray-300 px-4 py-3 overflow-y-auto" id="Type"
                    [(ngModel)]="PrintType" (click)="GetTypes()">
                    <option *ngFor="let type of types" [value]="type">
                        {{ type | titlecase }}
                    </option>
                </select>
            </div>

            <div class="flex flex-col mb-4" *ngIf="PrintType=='Class'">
                <label class="mb-2 primaryTxt" for="Class">Class</label>
                <select class="rounded-lg border border-solid border-gray-300 px-4 py-3 overflow-y-auto" id="Class"
                    [(ngModel)]="SelectedClassId">
                    <option [value]="0" disabled selected hidden>Choose Class</option>
                    <option *ngFor="let class of classes" [value]="class.id">{{ class.name }}</option>
                    <option *ngIf="classes.length === 0" disabled selected>No Data Found</option>
                </select>
            </div>

            <div class="flex flex-col mb-4" *ngIf="PrintType=='Teacher'">
                <label class="mb-2 primaryTxt" for="Teacher">Teacher</label>
                <select class="rounded-lg border border-solid border-gray-300 px-4 py-3 overflow-y-auto" id="Teacher"
                    [(ngModel)]="SelectedTeacherId">
                    <option [value]="0" disabled selected hidden>Choose Teacher</option>
                    <option *ngFor="let t of Teachers" [value]="t.id">{{ t.en_name }}</option>
                    <option *ngIf="Teachers.length === 0" disabled selected>No Data Found</option>
                </select>
            </div>
        </div>

        <div class="flex justify-end">
            <button [disabled]="isLoading" class="secondaryBg text-white font-medium px-4 py-2 rounded-lg"
                (click)="Print()">
                <span *ngIf="!isLoading">Print</span>
                <i *ngIf="isLoading" class="fas fa-spinner fa-spin"></i>
            </button>
        </div>
    </div>
</div>


<div class="absolute -top-[9999px] -left-[9999px]">
    <div id="Data" class="hidden">
        <div class="overflow-x-auto">
            <div class="bg-gray-300 text-center text-xl font-bold py-4 mb-4 print:mb-8 print:pb-4">
                {{ ClassName }}
            </div>

            <table class="table-auto w-full text-sm text-left border-collapse border border-gray-300">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border p-2">Day</th>
                        <th class="border p-2" *ngFor="let i of [].constructor(MaxPeriods); let period = index">
                            Session {{ period + 1 }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let day of TimeTable">
                        <td class="border p-2 font-medium">{{ day.dayName }}</td>

                        <td class="border p-2" *ngFor="let i of [].constructor(MaxPeriods); let period = index">
                            <ng-container *ngFor="let grade of day.grades">
                                <ng-container *ngFor="let classroom of grade.classrooms">
                                    <ng-container *ngIf="classroom.classroomName === ClassName">
                                        <ng-container *ngIf="classroom.sessions[period] as session">
                                            <div *ngFor="let subject of session.subjects">
                                                <div class="font-semibold text-blue-600">{{ subject.subjectName }}</div>
                                                <div class="text-gray-500 text-xs">
                                                    {{ subject.teacherName || 'No Teacher' }}
                                                </div>
                                            </div>
                                        </ng-container>
                                        <div *ngIf="!classroom.sessions[period]" class="text-gray-400">--</div>
                                    </ng-container>
                                </ng-container>
                            </ng-container>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>



<div class="absolute -top-[9999px] -left-[9999px]">
    <div id="DataTeacher" class="hidden">
        <div class="bg-gray-300 text-center text-xl font-bold py-4 mb-4 print:mb-8 print:pb-4">
            {{ TeacherName }}
        </div>
        <div class="overflow-x-auto">
            <div class="p-2">
                <table class="table-auto w-full text-sm text-left border-collapse border border-gray-300">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border p-2">Day</th>
                            <th class="border p-2" *ngFor="let i of [].constructor(MaxPeriods); let period = index">
                                Session {{ period + 1 }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let day of TimeTable">
                            <td class="border p-2 font-medium">
                                {{ day.dayName }}
                            </td>
                            <td class="border p-2" *ngFor="let i of [].constructor(MaxPeriods); let period = index">
                                <ng-container *ngIf="day.sessions[period] as session">
                                    <div *ngFor="let subject of session.subjects">
                                        <div class="font-semibold text-blue-600">{{ subject.subjectName }}</div>
                                        <div class="text-gray-500 text-xs" *ngFor="let classroom of session.classes">
                                            {{ classroom.gradeName }} / {{ classroom.classroomName }}
                                        </div>
                                    </div>
                                </ng-container>
                                <div *ngIf="!day.sessions[period]" class="text-gray-400">--</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="absolute -top-[9999px] -left-[9999px]">
    <div id="All" class="hidden">
        <div class="overflow-x-auto">
            <div *ngFor="let day of TimeTable2" class="mb-10 border rounded shadow">
                <div class="bg-gray-300 text-center font-bold py-2">
                    {{ day.dayName }}
                </div>
                <div *ngFor="let grade of day.grades" class="p-2">
                    <div class="text-md font-semibold mb-1">
                        Grade: {{ grade.gradeName }}
                    </div>
                    <table class="table-auto w-full text-sm text-left border-collapse border border-gray-300">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border p-2">Class Name</th>
                                <th class="border p-2" *ngFor="let i of [].constructor(MaxPeriods); let period = index">
                                    Session {{ period + 1 }}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let classroom of grade.classrooms">
                                <td class="border p-2 font-medium">
                                    {{ classroom.classroomName }}
                                </td>
                                <td class="border p-2" *ngFor="let session of classroom.sessions">
                                    <div *ngFor="let subject of session.subjects">
                                        <div class="font-semibold text-blue-600">{{ subject.subjectName }}</div>
                                        <div class="text-gray-500 text-xs">{{ subject.teacherName }}</div>
                                    </div>
                                    <div *ngIf="session.subjects.length === 0" class="text-gray-400">--</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>